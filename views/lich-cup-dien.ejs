<!DOCTYPE html>
<html>
<head>
  <title>Lịch Cúp Điện</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .table td {
      white-space: nowrap;
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .reason-cell {
      max-width: 300px !important;
      white-space: normal !important;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
    <div class="container">
      <a class="navbar-brand" href="/">EVN Manager</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="/">Công ty điện lực</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="/lich-cup-dien">Lịch cúp điện</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <a href="/" class="btn btn-secondary">Quay lại</a>
      <div class="text-muted">
        <% if (capNhatGanNhat) { %>
          Cập nhật lần cuối: <%= new Date(capNhatGanNhat.thoi_gian_ket_thuc).toLocaleString('vi-VN') %>
          (<%= Math.floor(capNhatGanNhat.tong_thoi_gian / 60) %> phút <%= Math.floor(capNhatGanNhat.tong_thoi_gian % 60) %> giây)
          - <%= capNhatGanNhat.so_lich_cup_dien %> lịch cúp điện
        <% } %>
      </div>
      <form action="/lich-cup-dien/delete-all" method="POST" style="display: inline;">
        <button type="submit" class="btn btn-danger" 
          onclick="return confirm('Bạn có chắc chắn muốn xóa toàn bộ lịch cúp điện?')">
          Xóa toàn bộ dữ liệu
        </button>
      </form>
    </div>
    
    <h1>Lịch Cúp Điện</h1>
    
    <div class="mb-3">
      <form class="row g-3" id="filterForm">
        <div class="col-auto">
          <select name="zone" class="form-select" onchange="onZoneChange(this)">
            <option value="">Tất cả khu vực</option>
            <option value="mien_bac" <%= currentZone === 'mien_bac' ? 'selected' : '' %>>Miền Bắc</option>
            <option value="mien_trung" <%= currentZone === 'mien_trung' ? 'selected' : '' %>>Miền Trung</option>
            <option value="mien_nam" <%= currentZone === 'mien_nam' ? 'selected' : '' %>>Miền Nam</option>
          </select>
        </div>
        <div class="col-auto">
          <select name="ma_dien_luc" class="form-select" onchange="onCongTyChange(this)" <%= !currentZone ? 'disabled' : '' %>>
            <option value="">Tất cả công ty điện lực</option>
            <% congTyList.forEach(function(congTy) { %>
              <option value="<%= congTy.ma_dien_luc %>" 
                <%= currentMaDienLuc === congTy.ma_dien_luc ? 'selected' : '' %>
                data-zone="<%= congTy.zone %>">
                <%= congTy.ten_dien_luc %>
              </option>
            <% }); %>
          </select>
        </div>
        <div class="col-auto">
          <select name="ma_cong_ty_con" class="form-select" onchange="this.form.submit()" <%= !currentMaDienLuc ? 'disabled' : '' %>>
            <option value="">Tất cả điện lực</option>
            <% congTyConList.forEach(function(congTyCon) { %>
              <option value="<%= congTyCon.ma_cong_ty_con %>" 
                <%= currentMaCongTyCon === congTyCon.ma_cong_ty_con ? 'selected' : '' %>>
                <%= congTyCon.ten_cong_ty_con %>
              </option>
            <% }); %>
          </select>
        </div>
        <div class="col-auto">
          <input type="date" name="date" class="form-control" value="<%= currentDate %>" onchange="this.form.submit()">
        </div>
        <div class="col-auto">
          <button type="submit" class="btn btn-primary">Lọc</button>
          <a href="/lich-cup-dien" class="btn btn-secondary">Xóa bộ lọc</a>
        </div>
      </form>
    </div>

    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th>STT</th>
            <th>Công ty điện lực</th>
            <th>Điện lực</th>
            <th>Trạm</th>
            <th>Thời gian bắt đầu</th>
            <th>Thời gian kết thúc</th>
            <th>Khu vực</th>
            <th>Lý do</th>
            <th>Trạng thái</th>
            <th>Loại cắt điện</th>
          </tr>
        </thead>
        <tbody>
          <% lichCupDien.forEach(function(item, index) { %>
            <tr>
              <td><%= index + 1 %></td>
              <td><%= item.ten_dien_luc %></td>
              <td><%= item.ten_cong_ty_con %></td>
              <td><%= item.ten_tram || '—' %></td>
              <td><%= new Date(item.thoi_gian_bat_dau).toLocaleString('vi-VN') %></td>
              <td><%= new Date(item.thoi_gian_ket_thuc).toLocaleString('vi-VN') %></td>
              <td><%= item.khu_vuc %></td>
              <td class="reason-cell"><%= item.ly_do %></td>
              <td><%= item.trang_thai || '—' %></td>
              <td><%= item.loai_cat_dien || '—' %></td>
            </tr>
          <% }); %>
          <% if (lichCupDien.length === 0) { %>
            <tr>
              <td colspan="10" class="text-center">Không có dữ liệu</td>
            </tr>
          <% } %>
        </tbody>
      </table>

      <% if (pagination.totalPages > 1) { %>
        <nav aria-label="Page navigation">
          <ul class="pagination justify-content-center">
            <li class="page-item <%= pagination.page === 1 ? 'disabled' : '' %>">
              <a class="page-link" href="<%= getPageUrl(pagination.page - 1) %>" tabindex="-1">
                Trước
              </a>
            </li>

            <% for(let i = 1; i <= pagination.totalPages; i++) { %>
              <% if (
                i === 1 || 
                i === pagination.totalPages || 
                (i >= pagination.page - 2 && i <= pagination.page + 2)
              ) { %>
                <li class="page-item <%= pagination.page === i ? 'active' : '' %>">
                  <a class="page-link" href="<%= getPageUrl(i) %>"><%= i %></a>
                </li>
              <% } else if (
                i === pagination.page - 3 || 
                i === pagination.page + 3
              ) { %>
                <li class="page-item disabled">
                  <span class="page-link">...</span>
                </li>
              <% } %>
            <% } %>

            <li class="page-item <%= pagination.page === pagination.totalPages ? 'disabled' : '' %>">
              <a class="page-link" href="<%= getPageUrl(pagination.page + 1) %>">
                Sau
              </a>
            </li>
          </ul>
        </nav>

        <div class="text-center text-muted">
          Hiển thị <%= lichCupDien.length %> / <%= pagination.totalItems %> lịch cúp điện
        </div>
      <% } %>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  function onZoneChange(select) {
    const form = document.getElementById('filterForm');
    const congTySelect = form.querySelector('[name="ma_dien_luc"]');
    const congTyConSelect = form.querySelector('[name="ma_cong_ty_con"]');
    
    // Reset và disable các select phía sau
    congTySelect.value = '';
    congTyConSelect.value = '';
    
    congTySelect.disabled = !select.value;
    congTyConSelect.disabled = true;
    
    form.submit();
  }

  function onCongTyChange(select) {
    const form = document.getElementById('filterForm');
    const congTyConSelect = form.querySelector('[name="ma_cong_ty_con"]');
    
    // Reset và enable/disable select công ty con
    congTyConSelect.value = '';
    congTyConSelect.disabled = !select.value;
    
    form.submit();
  }
  </script>
</body>
</html> 