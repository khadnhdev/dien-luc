<%- include('header', { 
  title: 'Quản lý Đăng ký Theo dõi',
  customStyles: `
    /* Google ID styles */
    code {
      background: #f8f9fa;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.9rem;
      color: #495057;
    }
    
    .btn-link {
      color: #6c757d;
      transition: all 0.2s;
    }
    
    .btn-link:hover {
      color: var(--primary-color);
      transform: scale(1.1);
    }
    
    /* Styles riêng cho trang này nếu cần */
  `
}) %>

<!-- Modal -->
<div class="modal fade" id="actionModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Chọn thao tác</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <h6 class="company-name mb-4"></h6>
        <div class="d-grid gap-3">
          <button type="button" class="btn btn-primary btn-lg notify-btn">
            <i class="bi bi-bell"></i> Nhắc nhở lịch cúp điện
          </button>
          <a href="#" class="btn btn-info btn-lg view-schedule-btn">
            <i class="bi bi-calendar"></i> Xem lịch cúp điện
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container mt-4">
  <h1>Quản lý Đăng ký Theo dõi</h1>
  
  <!-- Google ID Section -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="d-flex align-items-center justify-content-between">
        <div>
          <label class="form-label mb-0">Google ID của bạn:</label>
          <div class="d-flex align-items-center gap-2">
            <code id="googleId" class="user-select-all">
              <span id="maskedId"><%= user.google_id.substring(0, 6) %>•••••••••••</span>
              <span id="fullId" style="display: none"><%= user.google_id %></span>
            </code>
            <button class="btn btn-link btn-sm p-0" onclick="toggleGoogleId()" title="Hiện/Ẩn">
              <i class="bi bi-eye" id="toggleIcon"></i>
            </button>
            <button class="btn btn-link btn-sm p-0" onclick="copyGoogleId()" title="Copy">
              <i class="bi bi-clipboard"></i>
            </button>
          </div>
        </div>
        <div class="text-muted small">
          <i class="bi bi-info-circle"></i>
          Sử dụng Google ID này để gọi API
        </div>
      </div>
    </div>
  </div>
  
  <div class="alert alert-info">
    Bạn có thể đăng ký theo dõi tối đa <%= maxSubscriptions %> công ty.
    Hiện tại: <%= subscriptions.length %>/<%= maxSubscriptions %>
  </div>

  <% if (subscriptions.length < maxSubscriptions) { %>
    <div class="row">
      <!-- Chọn miền -->
      <div class="col-md-4">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">1. Chọn khu vực</h5>
          </div>
          <div class="card-body company-select">
            <div class="company-item zone-item <%= !selectedZone ? 'selected' : '' %>" 
                 data-zone="">
              Tất cả khu vực
            </div>
            <div class="company-item zone-item <%= selectedZone === 'mien_bac' ? 'selected' : '' %>"
                 data-zone="mien_bac">
              Miền Bắc
            </div>
            <div class="company-item zone-item <%= selectedZone === 'mien_trung' ? 'selected' : '' %>"
                 data-zone="mien_trung">
              Miền Trung
            </div>
            <div class="company-item zone-item <%= selectedZone === 'mien_nam' ? 'selected' : '' %>"
                 data-zone="mien_nam">
              Miền Nam
            </div>
          </div>
        </div>
      </div>

      <!-- Chọn công ty điện lực -->
      <div class="col-md-4">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">2. Chọn công ty điện lực</h5>
          </div>
          <div class="card-body company-select" id="companyList">
            <div class="text-center">Vui lòng chọn khu vực</div>
          </div>
        </div>
      </div>

      <!-- Chọn điện lực -->
      <div class="col-md-4">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">3. Chọn điện lực</h5>
          </div>
          <div class="card-body company-select" id="subCompanyList">
            <div class="text-center">Vui lòng chọn công ty điện lực</div>
          </div>
        </div>
      </div>
    </div>

    <form id="subscriptionForm" action="/subscriptions" method="POST">
      <input type="hidden" name="ma_cong_ty_con" id="selectedCompanyCon">
      <input type="hidden" name="type" id="subscriptionType">
    </form>
  <% } %>

  <div class="mt-4">
    <h2>Danh sách đăng ký</h2>
    <% if (subscriptions.length === 0) { %>
      <div class="alert alert-warning">
        Bạn chưa đăng ký theo dõi công ty nào
      </div>
    <% } else { %>
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Công ty</th>
              <th>Ngày đăng ký</th>
              <th>Thao tác</th>
            </tr>
          </thead>
          <tbody>
            <% subscriptions.forEach(function(sub) { %>
              <tr>
                <td><%= sub.ten_cong_ty_con %></td>
                <td><%= new Date(sub.created_at).toLocaleString('vi-VN') %></td>
                <td>
                  <form action="/subscriptions/<%= sub.id %>" method="POST" style="display:inline">
                    <input type="hidden" name="_method" value="DELETE">
                    <button type="submit" class="btn btn-sm btn-danger" 
                            onclick="return confirm('Bạn có chắc muốn hủy đăng ký?')">
                      Hủy đăng ký
                    </button>
                  </form>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    <% } %>
  </div>
</div>

<script defer>
function toggleGoogleId() {
  const maskedId = document.getElementById('maskedId');
  const fullId = document.getElementById('fullId');
  const toggleIcon = document.getElementById('toggleIcon');
  
  if (maskedId.style.display === 'none') {
    maskedId.style.display = 'inline';
    fullId.style.display = 'none';
    toggleIcon.classList.remove('bi-eye-slash');
    toggleIcon.classList.add('bi-eye');
  } else {
    maskedId.style.display = 'none';
    fullId.style.display = 'inline';
    toggleIcon.classList.remove('bi-eye');
    toggleIcon.classList.add('bi-eye-slash');
  }
}

async function copyGoogleId() {
  const fullId = document.getElementById('fullId').textContent;
  
  try {
    await navigator.clipboard.writeText(fullId);
    
    // Show tooltip
    const btn = event.currentTarget;
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-check text-success"></i>';
    
    setTimeout(() => {
      btn.innerHTML = originalHtml;
    }, 2000);
  } catch (err) {
    console.error('Failed to copy:', err);
  }
}

document.addEventListener('DOMContentLoaded', function() {
  let selectedZone = '<%= selectedZone || "" %>';
  let selectedCompany = '<%= selectedCompany || "" %>';
  const subscriptions = <%- JSON.stringify(subscriptions) %>;
  const actionModal = new bootstrap.Modal(document.getElementById('actionModal'));
  let selectedCompanyCon = null;

  function selectZone(zone) {
    selectedZone = zone;
    selectedCompany = '';
    
    // Reset danh sách công ty điện lực và điện lực
    document.querySelector('#subCompanyList').innerHTML = '<div class="text-center">Vui lòng chọn công ty điện lực</div>';
    
    if (zone) {
      document.querySelector('#companyList').innerHTML = '<div class="text-center">Đang tải...</div>';
      // Load danh sách công ty điện lực theo zone
      fetch(`/api/companies?zone=${zone}`, {
        headers: {
          'X-Google-ID': document.getElementById('fullId').textContent
        }
      })
        .then(res => res.json())
        .then(response => {
          if (!response.success) {
            throw new Error(response.error || 'Failed to fetch companies');
          }
          
          const companies = response.data.companies;
          const html = companies.map(company => `
            <div class="company-item" data-company-id="${company.id_cong_ty}">
              ${company.ten_cong_ty}
            </div>
          `).join('');
          document.querySelector('#companyList').innerHTML = html || '<div class="text-center">Không có dữ liệu</div>';
          
          // Thêm event listeners cho các công ty mới
          document.querySelectorAll('#companyList .company-item').forEach(item => {
            item.addEventListener('click', () => selectCompany(item.dataset.companyId));
          });
        })
        .catch(error => {
          console.error('Error:', error);
          document.querySelector('#companyList').innerHTML = 
            '<div class="text-center text-danger">Có lỗi xảy ra khi tải dữ liệu</div>';
        });
    } else {
      document.querySelector('#companyList').innerHTML = '<div class="text-center">Vui lòng chọn khu vực</div>';
    }
    
    refreshUI();
  }

  function selectCompany(companyId) {
    selectedCompany = companyId;
    
    document.querySelector('#subCompanyList').innerHTML = '<div class="text-center">Đang tải...</div>';
    
    fetch(`/api/subcompanies?company=${companyId}`, {
      headers: {
        'X-Google-ID': document.getElementById('fullId').textContent
      }
    })
      .then(res => res.json())
      .then(response => {
        if (!response.success) {
          throw new Error(response.error || 'Failed to fetch sub-companies');
        }
        
        const companies = response.data.companies;
        const html = companies.map(company => {
          const isSubscribed = subscriptions
            .some(s => s.ma_cong_ty_con === company.ma_cong_ty_con);
          
          return `
            <div class="company-item">
              <div class="d-flex justify-content-between align-items-center">
                <div>${company.ten_cong_ty_con}</div>
                ${isSubscribed 
                  ? '<span class="badge bg-success">Đã đăng ký nhắc nhở</span>'
                  : `<button type="button" class="btn btn-sm btn-primary"
                            onclick="showActionModal('${company.ma_cong_ty_con}', '${company.ten_cong_ty_con}')"
                            title="Chọn thao tác">
                        Chọn thao tác
                      </button>`
                }
              </div>
            </div>
          `;
        }).join('');
        document.querySelector('#subCompanyList').innerHTML = html || '<div class="text-center">Không có dữ liệu</div>';
        
        // Thêm event listeners cho các công ty con mới
        document.querySelectorAll('#subCompanyList .company-item[data-can-subscribe]').forEach(item => {
          item.addEventListener('click', () => submitSubscription(item.dataset.companyCon));
        });
      });
    
    refreshUI();
  }

  window.showActionModal = function(maCongTyCon, tenCongTyCon) {
    selectedCompanyCon = maCongTyCon;
    
    // Cập nhật nội dung modal
    document.querySelector('#actionModal .company-name').textContent = tenCongTyCon;
    document.querySelector('#actionModal .view-schedule-btn').href = 
      `/lich-cup-dien?ma_cong_ty_con=${maCongTyCon}`;
      
    // Thêm event listener cho nút nhắc nhở
    document.querySelector('#actionModal .notify-btn').onclick = () => {
      submitSubscription(maCongTyCon, 'notify');
      actionModal.hide();
    };
    
    actionModal.show();
  }

  function submitSubscription(maCongTyCon, type) {
    document.getElementById('selectedCompanyCon').value = maCongTyCon;
    document.getElementById('subscriptionType').value = type;
    document.getElementById('subscriptionForm').submit();
  }

  function refreshUI() {
    document.querySelectorAll('.company-item').forEach(item => {
      item.classList.remove('selected');
    });
    
    if (selectedZone) {
      document.querySelector(`.company-item[data-zone="${selectedZone}"]`)?.classList.add('selected');
    }
  }
      
    // Thêm event listeners cho các khu vực
    document.querySelectorAll('.zone-item').forEach(item => {
      item.addEventListener('click', () => selectZone(item.dataset.zone));
    });
});
</script>

<!-- Rest of the body content -->
</body>
</html> 