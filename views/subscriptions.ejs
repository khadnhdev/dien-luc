<!DOCTYPE html>
<html>
<head>
  <title>Quản lý Đăng ký Theo dõi</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Modal -->
  <div class="modal fade" id="actionModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Chọn thao tác</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <h6 class="company-name mb-4"></h6>
          <div class="d-grid gap-3">
            <button type="button" class="btn btn-primary btn-lg notify-btn">
              <i class="bi bi-bell"></i> Nhắc nhở lịch cúp điện
            </button>
            <a href="#" class="btn btn-info btn-lg view-schedule-btn">
              <i class="bi bi-calendar"></i> Xem lịch cúp điện
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script defer>
  document.addEventListener('DOMContentLoaded', function() {
    let selectedZone = '<%= selectedZone || "" %>';
    let selectedCompany = '<%= selectedCompany || "" %>';
    const subscriptions = <%- JSON.stringify(subscriptions) %>;
    const actionModal = new bootstrap.Modal(document.getElementById('actionModal'));
    let selectedCompanyCon = null;

    function selectZone(zone) {
      selectedZone = zone;
      selectedCompany = '';
      
      // Reset danh sách công ty điện lực và điện lực
      document.querySelector('#subCompanyList').innerHTML = '<div class="text-center">Vui lòng chọn công ty điện lực</div>';
      
      if (zone) {
        document.querySelector('#companyList').innerHTML = '<div class="text-center">Đang tải...</div>';
        // Load danh sách công ty điện lực theo zone
        fetch(`/api/companies?zone=${zone}`)
          .then(res => res.json())
          .then(companies => {
            const html = companies.map(company => `
              <div class="company-item" data-company-id="${company.ma_dien_luc}">
                ${company.ten_dien_luc}
              </div>
            `).join('');
            document.querySelector('#companyList').innerHTML = html || '<div class="text-center">Không có dữ liệu</div>';
            
            // Thêm event listeners cho các công ty mới
            document.querySelectorAll('#companyList .company-item').forEach(item => {
              item.addEventListener('click', () => selectCompany(item.dataset.companyId));
            });
          });
      } else {
        document.querySelector('#companyList').innerHTML = '<div class="text-center">Vui lòng chọn khu vực</div>';
      }
      
      refreshUI();
    }

    function selectCompany(companyId) {
      selectedCompany = companyId;
      
      document.querySelector('#subCompanyList').innerHTML = '<div class="text-center">Đang tải...</div>';
      
      fetch(`/api/subcompanies?company=${companyId}`)
        .then(res => res.json())
        .then(companies => {
          const html = companies.map(company => {
            const isSubscribed = subscriptions
              .some(s => s.ma_cong_ty_con === company.ma_cong_ty_con);
            
            return `
              <div class="company-item">
                <div class="d-flex justify-content-between align-items-center">
                  <div>${company.ten_cong_ty_con}</div>
                  ${isSubscribed 
                    ? '<span class="badge bg-success">Đã đăng ký nhắc nhở</span>'
                    : `<button type="button" class="btn btn-sm btn-primary"
                              onclick="showActionModal('${company.ma_cong_ty_con}', '${company.ten_cong_ty_con}')"
                              title="Chọn thao tác">
                        Chọn thao tác
                      </button>`
                  }
                </div>
              </div>
            `;
          }).join('');
          document.querySelector('#subCompanyList').innerHTML = html || '<div class="text-center">Không có dữ liệu</div>';
          
          // Thêm event listeners cho các công ty con mới
          document.querySelectorAll('#subCompanyList .company-item[data-can-subscribe]').forEach(item => {
            item.addEventListener('click', () => submitSubscription(item.dataset.companyCon));
          });
        });
      
      refreshUI();
    }

    window.showActionModal = function(maCongTyCon, tenCongTyCon) {
      selectedCompanyCon = maCongTyCon;
      
      // Cập nhật nội dung modal
      document.querySelector('#actionModal .company-name').textContent = tenCongTyCon;
      document.querySelector('#actionModal .view-schedule-btn').href = 
        `/lich-cup-dien?ma_cong_ty_con=${maCongTyCon}`;
        
      // Thêm event listener cho nút nhắc nhở
      document.querySelector('#actionModal .notify-btn').onclick = () => {
        submitSubscription(maCongTyCon, 'notify');
        actionModal.hide();
      };
      
      actionModal.show();
    }

    function submitSubscription(maCongTyCon, type) {
      document.getElementById('selectedCompanyCon').value = maCongTyCon;
      document.getElementById('subscriptionType').value = type;
      document.getElementById('subscriptionForm').submit();
    }

    function refreshUI() {
      document.querySelectorAll('.company-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      if (selectedZone) {
        document.querySelector(`.company-item[data-zone="${selectedZone}"]`)?.classList.add('selected');
      }
    }
      
    // Thêm event listeners cho các khu vực
    document.querySelectorAll('.zone-item').forEach(item => {
      item.addEventListener('click', () => selectZone(item.dataset.zone));
    });
  });
  </script>
  <style>
    .company-select {
      max-height: 400px;
      overflow-y: auto;
    }
    .company-item {
      padding: 10px 15px;
      border-bottom: 1px solid #eee;
    }
    .company-item:hover {
      background-color: #f8f9fa;
    }
    .btn-group .badge {
      padding: 8px 12px;
    }
    .modal-body .btn {
      padding: 1rem;
      font-size: 1.1rem;
    }
    .company-name {
      font-size: 1.2rem;
      text-align: center;
      color: #666;
    }
  </style>
</head>
<body>
  <!-- Modal -->
  <div class="modal fade" id="actionModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Chọn thao tác</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <h6 class="company-name mb-4"></h6>
          <div class="d-grid gap-3">
            <button type="button" class="btn btn-primary btn-lg notify-btn">
              <i class="bi bi-bell"></i> Nhắc nhở lịch cúp điện
            </button>
            <a href="#" class="btn btn-info btn-lg view-schedule-btn">
              <i class="bi bi-calendar"></i> Xem lịch cúp điện
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <%- include('navbar') %>

  <div class="container mt-4">
    <h1>Quản lý Đăng ký Theo dõi</h1>
    
    <div class="alert alert-info">
      Bạn có thể đăng ký theo dõi tối đa <%= maxSubscriptions %> công ty.
      Hiện tại: <%= subscriptions.length %>/<%= maxSubscriptions %>
    </div>

    <% if (subscriptions.length < maxSubscriptions) { %>
      <div class="row">
        <!-- Chọn miền -->
        <div class="col-md-4">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">1. Chọn khu vực</h5>
            </div>
            <div class="card-body company-select">
              <div class="company-item zone-item <%= !selectedZone ? 'selected' : '' %>" 
                   data-zone="">
                Tất cả khu vực
              </div>
              <div class="company-item zone-item <%= selectedZone === 'mien_bac' ? 'selected' : '' %>"
                   data-zone="mien_bac">
                Miền Bắc
              </div>
              <div class="company-item zone-item <%= selectedZone === 'mien_trung' ? 'selected' : '' %>"
                   data-zone="mien_trung">
                Miền Trung
              </div>
              <div class="company-item zone-item <%= selectedZone === 'mien_nam' ? 'selected' : '' %>"
                   data-zone="mien_nam">
                Miền Nam
              </div>
            </div>
          </div>
        </div>

        <!-- Chọn công ty điện lực -->
        <div class="col-md-4">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">2. Chọn công ty điện lực</h5>
            </div>
            <div class="card-body company-select" id="companyList">
              <div class="text-center">Vui lòng chọn khu vực</div>
            </div>
          </div>
        </div>

        <!-- Chọn điện lực -->
        <div class="col-md-4">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">3. Chọn điện lực</h5>
            </div>
            <div class="card-body company-select" id="subCompanyList">
              <div class="text-center">Vui lòng chọn công ty điện lực</div>
            </div>
          </div>
        </div>
      </div>

      <form id="subscriptionForm" action="/subscriptions" method="POST">
        <input type="hidden" name="ma_cong_ty_con" id="selectedCompanyCon">
        <input type="hidden" name="type" id="subscriptionType">
      </form>
    <% } %>

    <div class="mt-4">
      <h2>Danh sách đăng ký</h2>
      <% if (subscriptions.length === 0) { %>
        <div class="alert alert-warning">
          Bạn chưa đăng ký theo dõi công ty nào
        </div>
      <% } else { %>
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>Công ty</th>
                <th>Ngày đăng ký</th>
                <th>Thao tác</th>
              </tr>
            </thead>
            <tbody>
              <% subscriptions.forEach(function(sub) { %>
                <tr>
                  <td><%= sub.ten_cong_ty_con %></td>
                  <td><%= new Date(sub.created_at).toLocaleString('vi-VN') %></td>
                  <td>
                    <form action="/subscriptions/<%= sub.id %>" method="POST" style="display:inline">
                      <input type="hidden" name="_method" value="DELETE">
                      <button type="submit" class="btn btn-sm btn-danger" 
                              onclick="return confirm('Bạn có chắc muốn hủy đăng ký?')">
                        Hủy đăng ký
                      </button>
                    </form>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      <% } %>
    </div>
  </div>
</body>
</html> 